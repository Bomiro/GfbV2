const _0x169238=_0x517d;(function(_0x3fdecd,_0xd41efa){const _0x378eac=_0x517d,_0x1bbe03=_0x3fdecd();while(!![]){try{const _0x328069=parseInt(_0x378eac(0x14b))/0x1*(-parseInt(_0x378eac(0x16c))/0x2)+-parseInt(_0x378eac(0x149))/0x3+parseInt(_0x378eac(0x17c))/0x4+-parseInt(_0x378eac(0x136))/0x5*(-parseInt(_0x378eac(0x148))/0x6)+parseInt(_0x378eac(0x13e))/0x7*(-parseInt(_0x378eac(0x147))/0x8)+-parseInt(_0x378eac(0x173))/0x9*(parseInt(_0x378eac(0x178))/0xa)+parseInt(_0x378eac(0x17b))/0xb;if(_0x328069===_0xd41efa)break;else _0x1bbe03['push'](_0x1bbe03['shift']());}catch(_0x3359fd){_0x1bbe03['push'](_0x1bbe03['shift']());}}}(_0x3a56,0x8d2f7),require(_0x169238(0x144))[_0x169238(0x172)]());const express=require(_0x169238(0x13c)),Botly=require(_0x169238(0x138)),mongoose=require('mongoose'),axios=require(_0x169238(0x15a)),app=express();app[_0x169238(0x151)](express[_0x169238(0x140)]());const botly=new Botly({'accessToken':process[_0x169238(0x150)][_0x169238(0x134)],'verifyToken':process[_0x169238(0x150)][_0x169238(0x159)]});mongoose[_0x169238(0x160)](process[_0x169238(0x150)]['MONGO_URI'],{'useNewUrlParser':!![],'useUnifiedTopology':!![]})[_0x169238(0x16f)](()=>console[_0x169238(0x165)]('✅\x20Connected\x20to\x20MongoDB'))[_0x169238(0x174)](_0x5dcf26=>console[_0x169238(0x177)](_0x169238(0x14d),_0x5dcf26));const userSchema=new mongoose[(_0x169238(0x13d))]({'userId':String,'apiKey':String}),User=mongoose['model']('User',userSchema),users={},userStates={};async function loadUsers(){const _0x3250e9=_0x169238,_0x4a1387=await User['find']({});_0x4a1387[_0x3250e9(0x15c)](_0xfefbde=>{const _0x32d561=_0x3250e9;users[_0xfefbde[_0x32d561(0x179)]]={'apiKey':_0xfefbde[_0x32d561(0x154)],'imageUrl':null};}),console[_0x3250e9(0x165)]('🔄\x20Loaded\x20users\x20from\x20MongoDB.');}function _0x517d(_0x164469,_0x1288fd){const _0x3a56dd=_0x3a56();return _0x517d=function(_0x517d49,_0x8390b3){_0x517d49=_0x517d49-0x132;let _0x40666f=_0x3a56dd[_0x517d49];return _0x40666f;},_0x517d(_0x164469,_0x1288fd);}loadUsers(),botly['on']('message',async(_0x48d4e5,_0x8fd347)=>{const _0x130012=_0x169238;console['log'](_0x130012(0x135)+_0x48d4e5+_0x130012(0x14c));if(userStates[_0x48d4e5]===_0x130012(0x153)){const _0x54581e=await chatWithGemini(_0x8fd347[_0x130012(0x158)][_0x130012(0x164)],'hi');if(_0x54581e===_0x130012(0x168)){botly[_0x130012(0x171)]({'id':_0x48d4e5,'text':_0x130012(0x155)});return;}users[_0x48d4e5]={'apiKey':_0x8fd347['message'][_0x130012(0x164)],'imageUrl':null},delete userStates[_0x48d4e5],await User['updateOne']({'userId':_0x48d4e5},{'userId':_0x48d4e5,'apiKey':_0x8fd347[_0x130012(0x158)]['text']},{'upsert':!![]}),botly[_0x130012(0x171)]({'id':_0x48d4e5,'text':'✅\x20تم\x20حفظ\x20مفتاح\x20API\x20بنجاح!\x20يمكنك\x20الآن\x20استخدام\x20البوت.'});return;}if(!users[_0x48d4e5]){botly[_0x130012(0x171)]({'id':_0x48d4e5,'text':_0x130012(0x15b),'quick_replies':[botly[_0x130012(0x13a)](_0x130012(0x15e),_0x130012(0x166))]});return;}if(_0x8fd347[_0x130012(0x158)][_0x130012(0x139)]&&_0x8fd347[_0x130012(0x158)][_0x130012(0x139)][0x0]['type']==='image'){users[_0x48d4e5]['imageUrl']=_0x8fd347['message'][_0x130012(0x139)][0x0][_0x130012(0x14e)][_0x130012(0x13f)],botly['sendText']({'id':_0x48d4e5,'text':_0x130012(0x17e),'quick_replies':[botly[_0x130012(0x13a)](_0x130012(0x17a),'DELETE_IMAGE')]});return;}if(!_0x8fd347['message'][_0x130012(0x164)]){botly[_0x130012(0x171)]({'id':_0x48d4e5,'text':_0x130012(0x163)});return;}let _0x59f9af;users[_0x48d4e5][_0x130012(0x169)]?_0x59f9af=await analyzeImage(users[_0x48d4e5][_0x130012(0x154)],users[_0x48d4e5][_0x130012(0x169)],_0x8fd347[_0x130012(0x158)][_0x130012(0x164)]):_0x59f9af=await chatWithGemini(users[_0x48d4e5][_0x130012(0x154)],_0x8fd347[_0x130012(0x158)][_0x130012(0x164)]);if(_0x59f9af==='❌\x20حدث\x20خطأ\x20أثناء\x20التواصل\x20مع\x20Gemini.\x20تحقق\x20من\x20مفتاح\x20API.'){botly['sendText']({'id':_0x48d4e5,'text':_0x59f9af,'quick_replies':[botly[_0x130012(0x13a)](_0x130012(0x15e),'ENTER_API_KEY')]});return;}sendMessage(_0x48d4e5,_0x59f9af);}),botly['on'](_0x169238(0x137),(_0x27403f,_0x323f67,_0x13aef8)=>{const _0x4f31c3=_0x169238;if(_0x13aef8==='ENTER_API_KEY')userStates[_0x27403f]='waiting_for_api_key',botly[_0x4f31c3(0x171)]({'id':_0x27403f,'text':_0x4f31c3(0x145)});else _0x13aef8===_0x4f31c3(0x142)&&(users[_0x27403f][_0x4f31c3(0x169)]=null,botly[_0x4f31c3(0x171)]({'id':_0x27403f,'text':'🗑️\x20تم\x20حذف\x20الصورة\x20المخزنة!'}));});async function chatWithGemini(_0x353f10,_0x2b4b9d){const _0x5e1de7=_0x169238;try{const _0x3c666b=await axios[_0x5e1de7(0x157)]('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key='+_0x353f10,{'contents':[{'parts':[{'text':_0x2b4b9d}]}]});return _0x3c666b[_0x5e1de7(0x14a)][_0x5e1de7(0x16d)]?.[0x0]?.['content']?.[_0x5e1de7(0x133)]?.[0x0]?.[_0x5e1de7(0x164)]||_0x5e1de7(0x13b);}catch(_0x245b30){return console[_0x5e1de7(0x165)](_0x245b30),'❌\x20حدث\x20خطأ\x20أثناء\x20التواصل\x20مع\x20Gemini.\x20تحقق\x20من\x20مفتاح\x20API.';}}function _0x3a56(){const _0x51b848=['✅\x20تم\x20حفظ\x20الصورة!\x20يمكنك\x20الآن\x20إرسال\x20وصف\x20أو\x20سؤال\x20حولها.','🚀\x20Server\x20is\x20running\x20on\x20port\x203000','parts','FBTOKEN','user\x20','16455zSppSN','postback','botly','attachments','createQuickReply','❌\x20لم\x20أتمكن\x20من\x20الرد.','express','Schema','7ryoVVc','url','json','push','DELETE_IMAGE','image/png','dotenv','📌\x20يرجى\x20إرسال\x20مفتاح\x20API\x20الخاص\x20بـ\x20Gemini\x20الآن.','❌\x20لم\x20أتمكن\x20من\x20تحليل\x20الصورة.','5616536XzzvZw','1614pbJLMT','2634936iHsrsa','data','4eJsvDi','\x20sent\x20message','❌\x20MongoDB\x20Connection\x20Error:','payload','🚀\x20Facebook\x20Gemini\x20Bot\x20is\x20Running!','env','use','❌\x20حدث\x20خطأ\x20أثناء\x20تحليل\x20الصورة.\x20تحقق\x20من\x20مفتاح\x20API.','waiting_for_api_key','apiKey','⚠️\x20مفتاح\x20API\x20غير\x20صالح.\x0aاذا\x20لم\x20تكن\x20تتوفر\x20عليه،\x20شاهد\x20الفيديو\x20لمعرفة\x20كيفية\x20جلب\x20ذلك\x20المفتاح\x20و\x20التعامل\x20مع\x20البوت:\x0ahttps://fb.com/MoroccoAI.Official','/webhook','post','message','FBVT','axios','🔑\x20لإستخدام\x20البوت\x20يرجى\x20إدخال\x20مفتاح\x20API\x20الخاص\x20بـ\x20Gemini\x20لبدء\x20المحادثة.\x0a\x20اذا\x20لم\x20تكن\x20تتوفر\x20عليه،\x20شاهد\x20الفيديو\x20لمعرفة\x20كيفية\x20جلب\x20ذلك\x20المفتاح\x20و\x20التعامل\x20مع\x20البوت:\x0ahttps://fb.com/MoroccoAI.Official','forEach','router','📌\x20إدخال\x20API\x20Key','length','connect','arraybuffer','get','❌\x20الرجاء\x20إرسال\x20نص\x20أو\x20صورة\x20مع\x20النص.','text','log','ENTER_API_KEY','from','❌\x20حدث\x20خطأ\x20أثناء\x20التواصل\x20مع\x20Gemini.\x20تحقق\x20من\x20مفتاح\x20API.','imageUrl','content','toString','76334VaGBvJ','candidates','send','then','listen','sendText','config','468AjkAdu','catch','quick_replies','base64','error','102940BAsJDy','userId','🗑️\x20حذف\x20الصورة','14247255zwLxSd','2664584wdqVMI','substring'];_0x3a56=function(){return _0x51b848;};return _0x3a56();}async function analyzeImage(_0x3c7246,_0x3b2563,_0x42744e){const _0x508134=_0x169238;try{const _0x255497=await axios[_0x508134(0x162)](_0x3b2563,{'responseType':_0x508134(0x161)}),_0xe2ebdc=Buffer[_0x508134(0x167)](_0x255497[_0x508134(0x14a)],'binary'),_0x1fb17e=_0xe2ebdc[_0x508134(0x16b)](_0x508134(0x176)),_0x2c9c95=await axios['post']('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+_0x3c7246,{'contents':[{'parts':[{'inlineData':{'mimeType':_0x508134(0x143),'data':_0x1fb17e}},{'text':_0x42744e}]}]});return _0x2c9c95[_0x508134(0x14a)][_0x508134(0x16d)]?.[0x0]?.[_0x508134(0x16a)]?.['parts']?.[0x0]?.[_0x508134(0x164)]||_0x508134(0x146);}catch(_0x4c8411){return console[_0x508134(0x165)](_0x4c8411),_0x508134(0x152);}}function sendMessage(_0x2fa521,_0x4d6cba){const _0xf86b7b=_0x169238,_0x43cf79=0x7d0,_0x43ec84=0x7d0;let _0x2d35c8=[];while(_0x4d6cba['length']>0x0){_0x2d35c8[_0xf86b7b(0x141)](_0x4d6cba[_0xf86b7b(0x17d)](0x0,_0x43cf79)),_0x4d6cba=_0x4d6cba[_0xf86b7b(0x17d)](_0x43cf79);}_0x2d35c8[_0xf86b7b(0x15c)]((_0x12ec7a,_0x46f607)=>{setTimeout(()=>{const _0x5e4eba=_0x517d;let _0x3847d5={'id':_0x2fa521,'text':_0x12ec7a};users[_0x2fa521]&&users[_0x2fa521]?.[_0x5e4eba(0x169)]&&_0x46f607===_0x2d35c8[_0x5e4eba(0x15f)]-0x1&&(_0x3847d5[_0x5e4eba(0x175)]=[botly[_0x5e4eba(0x13a)](_0x5e4eba(0x17a),'DELETE_IMAGE')]),botly[_0x5e4eba(0x171)](_0x3847d5);},_0x46f607*_0x43ec84);});}app[_0x169238(0x162)]('/',(_0x346bcb,_0x26a8ec)=>_0x26a8ec[_0x169238(0x16e)](_0x169238(0x14f))),app[_0x169238(0x151)](_0x169238(0x156),botly[_0x169238(0x15d)]()),app[_0x169238(0x170)](0xbb8,()=>console['log'](_0x169238(0x132)));
