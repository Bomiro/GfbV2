const _0x4bd118=_0x28c7;(function(_0x279116,_0xfdca79){const _0x2cd342=_0x28c7,_0xc427ce=_0x279116();while(!![]){try{const _0x5dcc34=-parseInt(_0x2cd342(0x1a5))/0x1*(parseInt(_0x2cd342(0x1a1))/0x2)+-parseInt(_0x2cd342(0x19a))/0x3+parseInt(_0x2cd342(0x190))/0x4+parseInt(_0x2cd342(0x194))/0x5*(parseInt(_0x2cd342(0x199))/0x6)+parseInt(_0x2cd342(0x198))/0x7+-parseInt(_0x2cd342(0x1ae))/0x8*(-parseInt(_0x2cd342(0x18d))/0x9)+-parseInt(_0x2cd342(0x19d))/0xa*(parseInt(_0x2cd342(0x1ad))/0xb);if(_0x5dcc34===_0xfdca79)break;else _0xc427ce['push'](_0xc427ce['shift']());}catch(_0x466749){_0xc427ce['push'](_0xc427ce['shift']());}}}(_0x2424,0x412cf),require(_0x4bd118(0x1c3))[_0x4bd118(0x1a0)]());const express=require('express'),Botly=require(_0x4bd118(0x1cb)),mongoose=require(_0x4bd118(0x1c8)),axios=require(_0x4bd118(0x197)),app=express();function _0x2424(){const _0x4f4d26=['apiKey','createQuickReply','botly','toString','content','waiting_for_api_key','parts','message','length','binary','data','36279vwmanP','\x20sent\x20message','env','1786412lEMycc','postback','ENTER_API_KEY','🔄\x20Loaded\x20users\x20from\x20MongoDB.','5IqjALG','User','🚀\x20Facebook\x20Gemini\x20Bot\x20is\x20Running!','axios','3072664qbESIO','2605062bdsHjy','155631sXdJMW','error','get','91610dYqajj','substring','❌\x20لم\x20أتمكن\x20من\x20الرد.','config','196uYOTVI','catch','use','base64','4657uKxgZe','updateOne','log','url','listen','DELETE_IMAGE','attachments','🗑️\x20حذف\x20الصورة','1254RweAZW','992qTYiav','❌\x20حدث\x20خطأ\x20أثناء\x20التواصل\x20مع\x20Gemini.\x20تحقق\x20من\x20مفتاح\x20API.','✅\x20تم\x20حفظ\x20مفتاح\x20API\x20بنجاح!\x20يمكنك\x20الآن\x20استخدام\x20البوت.','⚠️\x20مفتاح\x20API\x20غير\x20صالح.\x0aاذا\x20لم\x20تكن\x20تتوفر\x20عليه،\x20شاهد\x20الفيديو\x20لمعرفة\x20كيفية\x20جلب\x20ذلك\x20المفتاح\x20و\x20التعامل\x20مع\x20البوت:\x0ahttps://fb.com/MoroccoAI.Official','image','🚀\x20Server\x20is\x20running\x20on\x20port\x20','🔑\x20لإستخدام\x20البوت\x20يرجى\x20إدخال\x20مفتاح\x20API\x20الخاص\x20بـ\x20Gemini\x20لبدء\x20المحادثة.\x0a\x20اذا\x20لم\x20تكن\x20تتوفر\x20عليه،\x20شاهد\x20الفيديو\x20لمعرفة\x20كيفية\x20جلب\x20ذلك\x20المفتاح\x20و\x20التعامل\x20مع\x20البوت:\x0ahttps://fb.com/MoroccoAI.Official','quick_replies','sendText','type','userId','📌\x20يرجى\x20إرسال\x20مفتاح\x20API\x20الخاص\x20بـ\x20Gemini\x20الآن.','imageUrl','📌\x20إدخال\x20API\x20Key','https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=','user\x20','✅\x20Connected\x20to\x20MongoDB','send','json','candidates','https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=','dotenv','FBVT','text','arraybuffer','forEach','mongoose'];_0x2424=function(){return _0x4f4d26;};return _0x2424();}app[_0x4bd118(0x1a3)](express[_0x4bd118(0x1c0)]());function _0x28c7(_0x5dfa88,_0x1ae7c7){const _0x242496=_0x2424();return _0x28c7=function(_0x28c714,_0xf98765){_0x28c714=_0x28c714-0x187;let _0x50900c=_0x242496[_0x28c714];return _0x50900c;},_0x28c7(_0x5dfa88,_0x1ae7c7);}const botly=new Botly({'accessToken':process[_0x4bd118(0x18f)]['FBTOKEN'],'verifyToken':process[_0x4bd118(0x18f)][_0x4bd118(0x1c4)]});mongoose['connect'](process['env']['MONGO_URI'],{'useNewUrlParser':!![],'useUnifiedTopology':!![]})['then'](()=>console[_0x4bd118(0x1a7)](_0x4bd118(0x1be)))[_0x4bd118(0x1a2)](_0x571d8c=>console[_0x4bd118(0x19b)]('❌\x20MongoDB\x20Connection\x20Error:',_0x571d8c));const userSchema=new mongoose['Schema']({'userId':String,'apiKey':String}),User=mongoose['model'](_0x4bd118(0x195),userSchema),users={},userStates={};async function loadUsers(){const _0x1c459c=_0x4bd118,_0x240e65=await User['find']({});_0x240e65['forEach'](_0x3f7d57=>{const _0x53e933=_0x28c7;users[_0x3f7d57[_0x53e933(0x1b8)]]={'apiKey':_0x3f7d57[_0x53e933(0x1c9)],'imageUrl':null};}),console['log'](_0x1c459c(0x193));}loadUsers(),botly['on'](_0x4bd118(0x189),async(_0x1097a6,_0x121b13)=>{const _0x161cc2=_0x4bd118;console['log'](_0x161cc2(0x1bd)+_0x1097a6+_0x161cc2(0x18e));if(userStates[_0x1097a6]===_0x161cc2(0x187)){const _0x1de215=await chatWithGemini(_0x121b13[_0x161cc2(0x189)]['text'],'hi');if(_0x1de215===_0x161cc2(0x1af)){botly['sendText']({'id':_0x1097a6,'text':_0x161cc2(0x1b1)});return;}users[_0x1097a6]={'apiKey':_0x121b13[_0x161cc2(0x189)][_0x161cc2(0x1c5)],'imageUrl':null},delete userStates[_0x1097a6],await User[_0x161cc2(0x1a6)]({'userId':_0x1097a6},{'userId':_0x1097a6,'apiKey':_0x121b13[_0x161cc2(0x189)]['text']},{'upsert':!![]}),botly[_0x161cc2(0x1b6)]({'id':_0x1097a6,'text':_0x161cc2(0x1b0)});return;}if(!users[_0x1097a6]){botly['sendText']({'id':_0x1097a6,'text':_0x161cc2(0x1b4),'quick_replies':[botly['createQuickReply'](_0x161cc2(0x1bb),'ENTER_API_KEY')]});return;}if(_0x121b13['message'][_0x161cc2(0x1ab)]&&_0x121b13[_0x161cc2(0x189)][_0x161cc2(0x1ab)][0x0][_0x161cc2(0x1b7)]===_0x161cc2(0x1b2)){users[_0x1097a6][_0x161cc2(0x1ba)]=_0x121b13['message'][_0x161cc2(0x1ab)][0x0]['payload'][_0x161cc2(0x1a8)],botly['sendText']({'id':_0x1097a6,'text':'✅\x20تم\x20حفظ\x20الصورة!\x20يمكنك\x20الآن\x20إرسال\x20وصف\x20أو\x20سؤال\x20حولها.','quick_replies':[botly[_0x161cc2(0x1ca)](_0x161cc2(0x1ac),_0x161cc2(0x1aa))]});return;}if(!_0x121b13[_0x161cc2(0x189)][_0x161cc2(0x1c5)]){botly[_0x161cc2(0x1b6)]({'id':_0x1097a6,'text':'❌\x20الرجاء\x20إرسال\x20نص\x20أو\x20صورة\x20مع\x20النص.'});return;}let _0x7d558a;users[_0x1097a6][_0x161cc2(0x1ba)]?_0x7d558a=await analyzeImage(users[_0x1097a6][_0x161cc2(0x1c9)],users[_0x1097a6][_0x161cc2(0x1ba)],_0x121b13[_0x161cc2(0x189)][_0x161cc2(0x1c5)]):_0x7d558a=await chatWithGemini(users[_0x1097a6][_0x161cc2(0x1c9)],_0x121b13[_0x161cc2(0x189)][_0x161cc2(0x1c5)]);if(_0x7d558a==='❌\x20حدث\x20خطأ\x20أثناء\x20التواصل\x20مع\x20Gemini.\x20تحقق\x20من\x20مفتاح\x20API.'){botly['sendText']({'id':_0x1097a6,'text':_0x7d558a,'quick_replies':[botly['createQuickReply'](_0x161cc2(0x1bb),_0x161cc2(0x192))]});return;}sendMessage(_0x1097a6,_0x7d558a);}),botly['on'](_0x4bd118(0x191),(_0x549b01,_0x1d0bb3,_0x26f07d)=>{const _0x58dcf5=_0x4bd118;if(_0x26f07d==='ENTER_API_KEY')userStates[_0x549b01]='waiting_for_api_key',botly[_0x58dcf5(0x1b6)]({'id':_0x549b01,'text':_0x58dcf5(0x1b9)});else _0x26f07d===_0x58dcf5(0x1aa)&&(users[_0x549b01][_0x58dcf5(0x1ba)]=null,botly[_0x58dcf5(0x1b6)]({'id':_0x549b01,'text':'🗑️\x20تم\x20حذف\x20الصورة\x20المخزنة!'}));});async function chatWithGemini(_0x5d1a17,_0x3ef578){const _0x5e4653=_0x4bd118;try{const _0x368658=await axios['post'](_0x5e4653(0x1c2)+_0x5d1a17,{'contents':[{'parts':[{'text':_0x3ef578}]}]});return _0x368658[_0x5e4653(0x18c)][_0x5e4653(0x1c1)]?.[0x0]?.[_0x5e4653(0x1cd)]?.[_0x5e4653(0x188)]?.[0x0]?.['text']||_0x5e4653(0x19f);}catch(_0x39a823){return console[_0x5e4653(0x1a7)](_0x39a823),'❌\x20حدث\x20خطأ\x20أثناء\x20التواصل\x20مع\x20Gemini.\x20تحقق\x20من\x20مفتاح\x20API.';}}async function analyzeImage(_0x2ae102,_0x540dec,_0x54c01a){const _0x22bbed=_0x4bd118;try{const _0x404441=await axios[_0x22bbed(0x19c)](_0x540dec,{'responseType':_0x22bbed(0x1c6)}),_0x515f6a=Buffer['from'](_0x404441['data'],_0x22bbed(0x18b)),_0x18a2cd=_0x515f6a[_0x22bbed(0x1cc)](_0x22bbed(0x1a4)),_0x1577e4=await axios['post'](_0x22bbed(0x1bc)+_0x2ae102,{'contents':[{'parts':[{'inlineData':{'mimeType':'image/png','data':_0x18a2cd}},{'text':_0x54c01a}]}]});return _0x1577e4[_0x22bbed(0x18c)][_0x22bbed(0x1c1)]?.[0x0]?.[_0x22bbed(0x1cd)]?.[_0x22bbed(0x188)]?.[0x0]?.[_0x22bbed(0x1c5)]||'❌\x20لم\x20أتمكن\x20من\x20تحليل\x20الصورة.';}catch(_0x33afbd){return console[_0x22bbed(0x1a7)](_0x33afbd),'❌\x20حدث\x20خطأ\x20أثناء\x20تحليل\x20الصورة.\x20تحقق\x20من\x20مفتاح\x20API.';}}function sendMessage(_0x57420b,_0x5dc056){const _0x589b9d=_0x4bd118,_0x1872c5=0x7d0,_0x2d257a=0x7d0;let _0x133191=[];while(_0x5dc056[_0x589b9d(0x18a)]>0x0){_0x133191['push'](_0x5dc056[_0x589b9d(0x19e)](0x0,_0x1872c5)),_0x5dc056=_0x5dc056[_0x589b9d(0x19e)](_0x1872c5);}_0x133191[_0x589b9d(0x1c7)]((_0x5c6ef4,_0x5bb35d)=>{setTimeout(()=>{const _0x8164ce=_0x28c7;let _0x5e87de={'id':_0x57420b,'text':_0x5c6ef4};users[_0x57420b]&&users[_0x57420b]?.[_0x8164ce(0x1ba)]&&_0x5bb35d===_0x133191[_0x8164ce(0x18a)]-0x1&&(_0x5e87de[_0x8164ce(0x1b5)]=[botly[_0x8164ce(0x1ca)](_0x8164ce(0x1ac),_0x8164ce(0x1aa))]),botly['sendText'](_0x5e87de);},_0x5bb35d*_0x2d257a);});}app[_0x4bd118(0x19c)]('/',(_0x13a071,_0x39dcbb)=>_0x39dcbb[_0x4bd118(0x1bf)](_0x4bd118(0x196))),app[_0x4bd118(0x1a3)]('/webhook',botly['router']());const PORT=process['env']['PORT']||0xbb8;app[_0x4bd118(0x1a9)](PORT,()=>console[_0x4bd118(0x1a7)](_0x4bd118(0x1b3),PORT));
